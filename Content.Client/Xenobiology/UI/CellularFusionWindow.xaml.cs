using Content.Client.UserInterface.Controls;
using Content.Shared.Xenobiology.Systems;
using Content.Shared.Xenobiology.UI;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Utility;

namespace Content.Client.Xenobiology.UI;

[GenerateTypedNameReferences]
public sealed partial class CellularFusionWindow : FancyWindow
{
    public event Action? OnSync;

    private CellEntryControl? _selectedEntryA;
    private CellEntryControl? _selectedEntryB;

    private int _material;

    public CellularFusionWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        SyncButton.OnPressed += _ => OnSync?.Invoke();
    }

    public void UpdateState(CellularFusionUiState state)
    {
        _material = state.Material;
        MaterialLabel.Text = Loc.GetString("cellular-fusion-menu-cell-material-label", ("material", _material));

        CellContainerA.RemoveAllChildren();
        foreach (var savedCell in state.RemoteCells)
        {
            var entry = new CellEntryControl(savedCell, false);
            entry.OnSelect += SelectedCellEntryA;

            CellContainerA.AddChild(entry);
        }

        CellContainerB.RemoveAllChildren();
        foreach (var savedCell in state.RemoteCells)
        {
            var entry = new CellEntryControl(savedCell, false);
            entry.OnSelect += SelectedCellEntryB;

            CellContainerB.AddChild(entry);
        }
    }

    private void SelectedCellEntryA(CellEntryControl entry)
    {
        SelectCellEntry(entry, ref _selectedEntryA);
        CellANoSelectedLabel.Visible = _selectedEntryA is null;
        UpdateCellInfo();
    }

    private void SelectedCellEntryB(CellEntryControl entry)
    {
        SelectCellEntry(entry, ref _selectedEntryB);
        CellBNoSelectedLabel.Visible = _selectedEntryB is null;
        UpdateCellInfo();
    }

    private void SelectCellEntry(CellEntryControl? entryNew, ref CellEntryControl? entryPrevious)
    {
        entryPrevious?.SetState(true);
        entryNew?.SetState(false);

        entryPrevious = entryNew;
    }

    private void UpdateCellInfo()
    {
        CellInfoContainer.Visible = _selectedEntryA is not null && _selectedEntryB is not null;

        if (_selectedEntryA is not { } entryA || _selectedEntryB is not { } entryB)
            return;

        SetCellInfoName(SharedCellSystem.GetMergedName(entryA.Cell, entryB.Cell));
        SetCellInfoColor(SharedCellSystem.GetMergedColor(entryA.Cell, entryB.Cell));
    }

    private void SetCellInfoName(string name)
    {
        CellNameLabel.Text = Loc.GetString("cell-sequencer-menu-cell-name-label", ("name", name));
    }

    private void SetCellInfoColor(Color color)
    {
        var colorTitle = Loc.GetString("cell-sequencer-menu-cell-color-label", ("color", color.ToHex()));

        if (!FormattedMessage.TryFromMarkup(colorTitle, out var colorMarkup))
        {
            CellColorLabel.SetMessage(colorTitle);
            return;
        }

        CellColorLabel.SetMessage(colorMarkup);
    }
}
