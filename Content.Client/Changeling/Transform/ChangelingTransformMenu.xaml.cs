using Content.Client.UserInterface.Controls;
using Content.Shared.Changeling.Transform;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client.Changeling.Transform;

[GenerateTypedNameReferences]
public sealed partial class ChangelingTransformMenu : RadialMenu
{
    [Dependency] private readonly IClyde _clyde = default!;
    [Dependency] private readonly IEntityManager _entManager = default!;

    private EntityUid _player;

    public event Action<ChangelingTransformRadialMessage>? OnTransformMenuClicked;
    public ChangelingTransformMenu()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);
    }
    public void Owner(EntityUid owner)
    {
        _player = owner;

        if (!_entManager.EntityExists(_player))
        {
            Close();
            return;
        }

        BuildButtons();
        UpdatePosition();
    }

    private void BuildButtons()
    {
        var ev = new GetChangelingAiIdentitiesRadialEvent();
        _entManager.EventBus.RaiseLocalEvent(_player,  ref ev);

    }
    private void UpdatePosition()
    {
        if (!_entManager.TryGetComponent(_player, out TransformComponent? xform))
        {
            Close();
            return;
        }

        if (!xform.Coordinates.IsValid(_entManager))
        {
            Close();
            return;
        }

        var coords = _entManager.System<SpriteSystem>().GetSpriteScreenCoordinates((_player, null, xform));

        if (!coords.IsValid)
        {
            Close();
            return;
        }

        OpenScreenAt(coords.Position, _clyde);
    }
}
