using System.Numerics;
using Content.Client.UserInterface.Systems.Chat.Widgets;
using Content.Shared.CCVar;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared;
using Robust.Shared.Configuration;

namespace Content.Client.UserInterface.Screens;

[GenerateTypedNameReferences]
public sealed partial class SeparatedChatGameScreen : InGameScreen
{
    private readonly IConfigurationManager _cfg = IoCManager.Resolve<IConfigurationManager>();
    [Dependency] private readonly IUserInterfaceManager _uiManager = default!;

    private readonly float _chatMinWidth;
    private float? _deferredSplitFraction = null;

    public SeparatedChatGameScreen()
    {
        RobustXamlLoader.Load(this);

        AutoscaleMaxResolution = new Vector2i(1080, 770);

        SetAnchorPreset(ScreenContainer, LayoutPreset.Wide);
        SetAnchorPreset(ViewportContainer, LayoutPreset.Wide);
        SetAnchorPreset(MainViewport, LayoutPreset.Wide);
        SetAnchorAndMarginPreset(Inventory, LayoutPreset.BottomLeft, margin: 5);
        SetAnchorAndMarginPreset(TopLeftContainer, LayoutPreset.TopLeft, margin: 10);
        SetAnchorAndMarginPreset(Ghost, LayoutPreset.BottomWide, margin: 80);
        SetAnchorAndMarginPreset(Hotbar, LayoutPreset.BottomWide, margin: 5);
        SetAnchorAndMarginPreset(Alerts, LayoutPreset.CenterRight, margin: 10);

        ScreenContainer.OnSplitResizeFinished += () =>
            OnChatResized?.Invoke(new Vector2(ScreenContainer.SplitFraction, 0));

        ViewportContainer.OnResized += ResizeActionContainer;

        OnResized += RecalculateViewportDesiredSize;
        // Note: currently these run after the like callbacks on MainViewport,
        // and may misbehave if that changes.
        _cfg.OnValueChanged(CCVars.ViewportMinimumWidth, _ => RecalculateViewportDesiredSize());
        _cfg.OnValueChanged(CCVars.ViewportStretch, _ => RecalculateViewportDesiredSize());
        _cfg.OnValueChanged(CCVars.ViewportSnapToleranceClip, _ => RecalculateViewportDesiredSize());
        _cfg.OnValueChanged(CCVars.ViewportSnapToleranceMargin, _ => RecalculateViewportDesiredSize());
        _cfg.OnValueChanged(CCVars.ViewportScaleRender, _ => RecalculateViewportDesiredSize());
        _cfg.OnValueChanged(CCVars.ViewportFixedScaleFactor, _ => RecalculateViewportDesiredSize());
        _cfg.OnValueChanged(CVars.DisplayUIScale, _ => RecalculateViewportDesiredSize());

        _chatMinWidth = SeparatedChatPanel.MinWidth;
    }

    private void ResizeActionContainer()
    {
        float indent = 20;
        Actions.ActionsContainer.MaxGridWidth = ViewportContainer.Size.X - indent;
    }

    private void RecalculateViewportDesiredSize()
    {
        // When the main window is reszied, calculate a new min/max for the
        // ViewportContainer so that the chat will prefer to resize instead
        // of letterboxing the viewport.
        var uiScale = _cfg.GetCVar(CVars.DisplayUIScale);
        if (uiScale == 0f)
            uiScale = _uiManager.DefaultUIScale;

        var gameScale = MainViewport.Viewport.FixedRenderScale;
        var min = EyeManager.PixelsPerMeter * gameScale * _cfg.GetCVar(CCVars.ViewportMinimumWidth) / uiScale;
        var max = EyeManager.PixelsPerMeter * gameScale * _cfg.GetCVar(CCVars.ViewportMaximumWidth) / uiScale;

        // SplitContainer doesn't respect MaxSize, so set a MinSize on the chat instead.
        ViewportContainer.MinWidth = min;
        SeparatedChatPanel.MinWidth = Math.Max(_chatMinWidth, Width - max);

        if (_deferredSplitFraction is float fraction)
        {
            ScreenContainer.SplitFraction = fraction;
            _deferredSplitFraction = null;
        }

        // Correct for naughty behavior in SplitContainer by forcing a relayout.
        ScreenContainer.SplitCenter = Math.Clamp(ScreenContainer.SplitCenter, min, max);
    }

    public override ChatBox ChatBox => GetWidget<ChatBox>()!;

    public override void SetChatSize(Vector2 size)
    {
        ScreenContainer.ResizeMode = SplitContainer.SplitResizeMode.RespectChildrenMinSize;

        ScreenContainer.SplitFraction = size.X;
        if (ScreenContainer.SplitFraction == 0)
        {
            // Failed because SplitContainer tried to lay out its children
            // despite being 0x0 before first draw. Queue the size for later.
            _deferredSplitFraction = size.X;
        }
    }
}
