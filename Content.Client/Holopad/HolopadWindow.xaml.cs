using Content.Client.UserInterface.Controls;
using Content.Shared.Holopad;
using Content.Shared.Silicons.StationAi;
using Content.Shared.Telephone;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;
using Robust.Shared.Utility;
using System.Linq;

namespace Content.Client.Holopad;

[GenerateTypedNameReferences]
public sealed partial class HolopadWindow : FancyWindow
{
    [Dependency] private IEntityManager _entManager = default!;
    [Dependency] private IGameTiming _gameTiming = default!;

    //playerManager

    private EntityUid? _owner = null;
    private HolopadUiKey _currentUiKey;
    private TelephoneState _currentState;
    private TelephoneState _generalState;
    private TimeSpan _buttonUnlockTime;

    private TimeSpan _buttonUnlockDelay = TimeSpan.FromSeconds(1);
    private HashSet<TelephoneState> _generalStates = new HashSet<TelephoneState>() { TelephoneState.Idle, TelephoneState.Calling, TelephoneState.Ringing };

    public event Action<NetEntity>? SendHolopadStartNewCallMessageAction;
    public event Action? SendHolopadAnswerCallMessageAction;
    public event Action? SendHolopadEndCallMessageAction;
    public event Action? SendHolopadStartBroadcastMessageAction;
    public event Action? SendHolopadActivateProjectorMessageAction;
    public event Action? SendHolopadRequestStationAiMessageAction;

    public HolopadWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _buttonUnlockTime = _gameTiming.RealTime + _buttonUnlockDelay;

        // Assign button actions
        AnswerCallButton.OnPressed += args => { OnHolopadAnswerCallMessage(); };
        EndCallButton.OnPressed += args => { OnHolopadEndCallMessage(); };
        StartBroadcastButton.OnPressed += args => { OnHolopadStartBroadcastMessage(); };
        ActivateProjectorButton.OnPressed += args => { OnHolopadActivateProjectorMessage(); };
        RequestStationAiButton.OnPressed += args => { OnHolopadRequestStationAiMessage(); };

        HolopadDirectoryPanel.PanelOverride = new StyleBoxFlat
        {
            BackgroundColor = new Color(47, 47, 59),
            BorderColor = new Color(61, 64, 89),
            BorderThickness = new Thickness(2),
        };

        SubtitleText.SetMessage(FormattedMessage.FromMarkupOrThrow(Loc.GetString("holopad-window-subtitle")));
        OptionsText.SetMessage(FormattedMessage.FromMarkupOrThrow(Loc.GetString("holopad-window-options")));
    }

    #region: Button actions

    private void OnSendHolopadStartNewCallMessage(NetEntity receiver)
    {
        SendHolopadStartNewCallMessageAction?.Invoke(receiver);
    }

    private void OnHolopadAnswerCallMessage()
    {
        SendHolopadAnswerCallMessageAction?.Invoke();
    }

    private void OnHolopadEndCallMessage()
    {
        SendHolopadEndCallMessageAction?.Invoke();

        if (_currentUiKey == HolopadUiKey.AiRequestWindow)
            Close();
    }

    private void OnHolopadStartBroadcastMessage()
    {
        SendHolopadStartBroadcastMessageAction?.Invoke();
    }

    private void OnHolopadActivateProjectorMessage()
    {
        SendHolopadActivateProjectorMessageAction?.Invoke();
    }

    private void OnHolopadRequestStationAiMessage()
    {
        SendHolopadRequestStationAiMessageAction?.Invoke();
    }

    #endregion

    public void SetState(EntityUid owner, HolopadUiKey uiKey)
    {
        _owner = owner;
        _currentUiKey = uiKey;

        var isAi = _entManager.HasComponent<StationAiCoreComponent>(owner);

        switch (uiKey)
        {
            case HolopadUiKey.StandardWindow:
                HolopadDirectoryContainer.Visible = !isAi;
                StartBroadcastContainer.Visible = !isAi;
                RequestStationAiContainer.Visible = !isAi;
                ActivateProjectorContainer.Visible = isAi;
                break;

            case HolopadUiKey.AiActionWindow:
                HolopadDirectoryContainer.Visible = true;
                StartBroadcastContainer.Visible = true;
                break;

            case HolopadUiKey.AiRequestWindow:
                break;
        }
    }

    public void UpdateState(Dictionary<NetEntity, string> holopads)
    {
        if (_owner == null || !_entManager.TryGetComponent<TelephoneComponent>(_owner.Value, out var telephone))
            return;

        // Sort holopads alphabetically
        var holopadArray = holopads.ToArray();
        Array.Sort(holopadArray, AlphabeticalSort);

        // Clear excess children from the contact list
        while (ContactsList.ChildCount > holopadArray.Length)
            ContactsList.RemoveChild(ContactsList.GetChild(ContactsList.ChildCount - 1));

        // Make / update required children
        for (int i = 0; i < holopadArray.Length; i++)
        {
            var (netEntity, label) = holopadArray[i];

            if (i >= ContactsList.ChildCount)
            {
                var newContactButton = new HolopadContactButton();
                newContactButton.OnPressed += args => { OnSendHolopadStartNewCallMessage(newContactButton.NetEntity); };

                ContactsList.AddChild(newContactButton);
            }

            var child = ContactsList.GetChild(i);

            if (child is not HolopadContactButton)
                continue;

            var contactButton = (HolopadContactButton)child;
            contactButton.UpdateValues(netEntity, label);
        }

        // Update buttons
        UpdateAppearance();
    }

    private void UpdateAppearance()
    {
        if (_owner == null || !_entManager.TryGetComponent<TelephoneComponent>(_owner.Value, out var telephone))
            return;

        // Temporarily disable the interface buttons when the call state changes to prevent any misclicks 
        if (_currentState != telephone.CurrentState)
        {
            _currentState = telephone.CurrentState;
            _buttonUnlockTime = _gameTiming.RealTime + _buttonUnlockDelay;

            if (_generalStates.Contains(_currentState))
                _generalState = _currentState;
        }

        var lockButtons = _gameTiming.RealTime < _buttonUnlockTime;

        // Make / update required children
        foreach (var child in ContactsList.Children)
        {
            if (child is not HolopadContactButton)
                continue;

            var contactButton = (HolopadContactButton)child;
            contactButton.Disabled = (_currentState != TelephoneState.Idle || lockButtons);
        }

        // Update buttons
        var hasBroadcastAccess = false;

        AnswerCallButton.Disabled = (_currentState != TelephoneState.Ringing || lockButtons);
        EndCallButton.Disabled = (_currentState == TelephoneState.Idle || _currentState == TelephoneState.EndingCall || lockButtons);
        StartBroadcastButton.Disabled = (_currentState != TelephoneState.Idle || !hasBroadcastAccess || lockButtons);
        RequestStationAiButton.Disabled = (_currentState != TelephoneState.Idle || lockButtons);

        // Update container/button visibility
        FetchingAvailableHolopadsContainer.Visible = ContactsList.ChildCount == 0;
        CallPlacementControlsContainer.Visible = (_currentState == TelephoneState.Idle && _currentUiKey != HolopadUiKey.AiRequestWindow);
        ActiveCallControlsContainer.Visible = !CallPlacementControlsContainer.Visible;

        AnswerCallButton.Visible = (_generalState != TelephoneState.Calling);
        StartBroadcastButton.Visible = telephone.IsBroadcaster;

        IncomingCallText.Visible = (_generalState == TelephoneState.Ringing);
        OutgoingCallText.Visible = !IncomingCallText.Visible;
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        UpdateAppearance();
    }

    private sealed class HolopadContactButton : Button
    {
        public NetEntity NetEntity;

        public HolopadContactButton()
        {
            HorizontalExpand = true;
            SetHeight = 32;
            Margin = new Thickness(0f, 1f, 0f, 1f);
        }

        public void UpdateValues(NetEntity netEntity, string label)
        {
            NetEntity = netEntity;
            Text = label; // Capitalize label
        }
    }

    private int AlphabeticalSort(KeyValuePair<NetEntity, string> x, KeyValuePair<NetEntity, string> y)
    {
        if (string.IsNullOrEmpty(x.Value))
            return -1;

        if (string.IsNullOrEmpty(y.Value))
            return 1;

        return x.Value.CompareTo(y.Value);
    }
}
